var eighth = 0.25;

/*
The way a single cell is notated is like this:

['C4,0.25','E4,1.75','C4,0.25','E4,1.75','C4,0.25','E4,1.75'];

rests are ',0.25' or whatever
the numbers are fractions of an eighth note
*/

cells = [
    ['C4,0.25','E4,1.75','C4,0.25','E4,1.75','C4,0.25','E4,1.75'],
    ['C4,0.25','E4,0.75','F4,1','E4,2'],
    [',1','E4,1','F4,1','E4,1'],
    [',1','E4,1','F4,1','G4,1'],
    ['E4,1','F4,1','G4,1',',1'],
    ['C5,16'],
    [',7','C4,0.5','C4,0.5','C4,1',',9'],
    ['G4,12','F4,16'],
    ['B4,0.5','G4,0.5',',7'],
    ['B4,0.5','G4,0.5'],
    ['F4,0.5','G4,0.5','B4,0.5','G4,0.5','B4,0.5','G4,0.5'],
    ['F4,1','G4,1','B4,8','C5,2'],
    ['B4,0.5','G4,1.5','G4,0.5','F4,0.5','G4,1',',1.5','G4,6.5'],
    ['C5,8','B4,8','G4,8','F#4,8'],
    ['G4,0.5',',7.5'],
    ['G4,0.5','A4,0.5','C4,0.5','B4,0.5'],
    ['B4,0.5','C4,0.5','B4,0.5','C4,0.5','B4,0.5',',0.5'],
    ['E4,0.5','F#4,0.5','E4,0.5','F#4,0.5','E4,1.5','E4,0.5'],
    [',1.5', 'G5,1.5'],
    ['E4,0.5', 'F#4,0.5', 'E4,0.5', 'F#4,0.5', 'G3,1.5', 'E4,0.5', 'F#4,0.5', 'E4,0.5', 'F#4,0.5', 'E4,0.5'],
    ['F#4,6'],
    ['E4,3', 'E4,3', 'E4,3', 'E4,3', 'E4,3', 'F#4,3', 'G4,3', 'A4,3', 'B4,1'],
    ['E4,1', 'F#4,3', 'F#4,3', 'F#4,3', 'F#4,3', 'F#4,3', 'G4,3', 'A4,3', 'B4,2'],
    ['E4,1', 'F#4,1', 'G4,3', 'G4,3', 'G4,3', 'G4,3', 'G4,3', 'A4,3', 'B4,1'],
    ['E4,1', 'F#4,1', 'G4,1', 'A4,3', 'A4,3', 'A4,3', 'A4,3', 'A4,3', 'B4,3'],
    ['E4,1', 'F#4,1', 'G4,1', 'A4,1', 'B4,3', 'B4,3', 'B4,3', 'B4,3', 'B4,3'],
    ['E4,0.5', 'F#4,0.5', 'E4,0.5', 'F#4,0.5', 'G4,1', 'E4,0.5', 'G4,0.5', 'F#4,0.5', 'E4,0.5', 'F#4,0.5', 'E4,0.5'],
    ['E4,0.5', 'F#4,0.5', 'E4,0.5', 'F#4,0.5', 'E4,1.5', 'E4,0.5'],
    ['E4,6', 'G4,6', 'C5,6'],
    ['C5,12'],
    ['G4,0.5', 'F4,0.5', 'G4,0.5', 'B4,0.5', 'G4,0.5', 'B4,0.5'],
    ['F4,0.5', 'G4,0.5', 'F4,0.5', 'G4,0.5', 'B4,0.5', 'F4,6.5', 'G4,3'],
    ['G4,0.5', 'F4,0.5', ',1'],
    ['G4,0.5', 'F4,0.5'],
    ['F4,0.5', 'G4,0.5', 'B4,0.5', 'G4,0.5', 'B4,0.5', 'G4,0.5', 'B4,0.5', 'G4,0.5', 'B4,0.5', 'G4,0.5', ',7', 'A#4,2', 'G5,6', 'A5,1', 'G5,2', 'B5,1', 'A5,1.5', 'G5,0.5', 'E5,6', 'G5,1', 'F#5,7', ',5', 'E5,5', 'F5,12'],
    ['F4,0.5', 'G4,0.5', 'B4,0.5', 'G4,0.5', 'B4,0.5', 'G4,0.5'],
    ['F4,0.5', 'G4,0.5'],
    ['F4,0.5', 'G4,0.5', 'B4,0.5'],
    ['B4,0.5', 'G4,0.5', 'F4,0.5', 'G4,0.5', 'B4,0.5', 'C5,0.5'],
    ['B4,0.5', 'F4,0.5'],
    ['B4,0.5', 'G4,0.5'],
    ['C5,8', 'B4,8', 'A4,8', 'C5,8'],
    ['F5,0.5', 'E5,0.5', 'F5,0.5', 'E5,0.5', 'E5,1', 'E5,1', 'E5,1', 'F5,0.5', 'E5,0.5'],
    ['F5,1', 'E5,2', 'E5,1', 'C5,2'],
    ['D5,2', 'D5,2', 'G4,2'],
    ['G4,0.5', 'D5,0.5', 'E5,0.5', 'D5,0.5', ',1', 'G4,1', ',1', 'G4,1', ',1', 'G4,1', 'G4,0.5', 'D5,0.5', 'E5,0.5', 'D5,0.5'],
    ['D5,0.5', 'E5,0.5', 'D5,1'],
    ['G4,12', 'G4,8', 'F4,10'],
    ['F4,0.5', 'G4,0.5', 'Bb4,0.5', 'G4,0.5', 'Bb4,0.5', 'G4,0.5'],
    ['F4,0.5', 'G4,0.5'],
    ['F4,0.5', 'G4,0.5', 'Bb4,0.5'],
    ['G4,0.5', 'Bb4,0.5'],
    ['Bb4,0.5', 'G4,0.5']
];

var players = [];

var playCell = function(n,w) {
    var j = function(i,f) {
        if (i in cells[n]) {
            var k = getNote(cells[n][i].split(',')[0],w);
            k.osc.addEventListener('ended',()=>j(i+1,f));
            k.start();
            k.stop(cells[n][i].split(',')[1]*eighth);
        } else {
            f();
        }
    };
    return new Promise((resolve)=>j(0,resolve));
}

var avCell = function() {
    return players.reduce((a,b)=>a+b.cell,0)/players.length;
}

var Individual = function(w='sine') {
    this.cell = 0;
    this.wave = w;
    players.push(this);
    document.dispatchEvent(new Event('av'));
}

Individual.prototype.play = function() {
    /*.1 probability of advancing if mean*/
    if (this.cell == cells.length) {
        if (Math.random()<0.42) {
            return;
        }
    } else {
        if (Math.random()<Math.atan(avCell()-this.cell-4)/Math.PI+0.5) {
            this.cell++;
            document.dispatchEvent(new Event('av'));
        }
    }
    playCell(this.cell,this.wave).then(()=>this.play());
}